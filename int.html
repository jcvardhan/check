<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Proctored Fullscreen Exam — Demo</title>
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
  body{margin:0;background:#0f172a;color:#e6eef8;display:flex;align-items:center;justify-content:center;min-height:100vh}
  .card{width:960px;max-width:95%;background:linear-gradient(180deg,#0b1220 0%, #081021 100%);border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(2,6,23,.7);border:1px solid rgba(255,255,255,0.03)}
  h1{margin:0 0 8px;font-size:20px}
  .info{font-size:13px;color:#a8c0d8;margin-bottom:12px}
  .btn{background:#2563eb;border:none;color:white;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .q{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;margin:10px 0}
  label{display:block;margin:8px 0;font-size:14px}
  textarea,input[type="text"]{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  .small{font-size:13px;color:#9fb3d6}
  #violations{background:#111827;padding:10px;border-radius:8px;margin-top:10px;color:#ffdede}
  #status{margin-left:8px;font-weight:700}
  .hidden{display:none}
  .snapshots{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .snapshots img{width:80px;height:60px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,0.06)}
  .footer{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:14px}
</style>
</head>
<body>
  <div class="card" id="card">
    <h1>Proctored Fullscreen Exam — Demo</h1>
    <div class="info">You must enter full screen to begin. Exiting full screen or switching away counts as a violation. 3 violations → exam ends.</div>

    <div id="preExam">
      <p class="small">Name: <input id="name" type="text" placeholder="Enter your name (optional)" style="width:250px"/></p>
      <p class="small">Enable webcam snapshots (recommended for proctoring): <input id="enableCam" type="checkbox" checked/></p>
      <button id="startBtn" class="btn">Enter Fullscreen & Start Exam</button>
      <div id="startMsg" class="small" style="margin-top:8px;color:#cbdcff"></div>
    </div>

    <form id="examForm" class="hidden" autocomplete="off">
      <div id="questions">
        <!-- Questions generated here -->
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:8px">
        <button id="submitBtn" class="btn" type="button">Submit Exam</button>
        <div class="small">Violations: <span id="violCount">0</span> / 3 <span id="status"></span></div>
      </div>

      <div id="violations" class="hidden">
        <strong>Violations log</strong>
        <ul id="violList"></ul>
      </div>

      <div id="cameraInfo" class="small" style="margin-top:8px">Camera snapshots (local):</div>
      <div class="snapshots" id="snapshots"></div>

      <div class="footer">
        <div class="small">Time elapsed: <span id="elapsed">00:00</span></div>
        <div class="small">Exam will auto-end on 3 violations.</div>
      </div>
    </form>

    <div id="endScreen" class="hidden" style="margin-top:12px">
      <h2 id="endTitle">Exam finished</h2>
      <p id="endText" class="small"></p>
      <button id="restartBtn" class="btn">Restart (refresh page)</button>
    </div>
  </div>

<script>
/*
  Single-file proctored exam demo.
  - Heuristics used (best-effort):
    * fullscreenchange events (enter/exit)
    * document.visibilitychange (tab switches or minimize)
    * window blur/focus (window switching)
    * copy and paste detection on question text
    * basic devtools detection via dimension and timing heuristics
    * periodic webcam snapshots (if permitted). Images kept in memory only.
  - Limitations:
    * Cannot read other tab URLs or detect their content from a normal web page.
    * For production, integrate with server-side logging / secure browser or dedicated proctoring.
*/

const QUESTIONS = [
  {q:"Which planet is known as the Red Planet?", type:"mc", choices:["Earth","Mars","Jupiter","Venus"], name:"q1"},
  {q:"What is the capital of France?", type:"mc", choices:["Berlin","London","Paris","Rome"], name:"q2"},
  {q:"Which language is primarily used for Android development?", type:"mc", choices:["Swift","Kotlin","Ruby","PHP"], name:"q3"},
  {q:"Briefly name a unit of electrical resistance.", type:"text", placeholder:"e.g., ohm", name:"q4"},
  {q:"What does CPU stand for?", type:"text", placeholder:"Enter full form", name:"q5"}
];

let violations = 0;
const MAX_VIOL = 3;
let violationsLog = [];
let examRunning = false;
let startTime = null;
let timerInterval = null;

// Webcam
let useCam = true;
let mediaStream = null;
let snapshotInterval = null;
const SNAP_INTERVAL_MS = 10000; // every 10s

// Devtools detection heuristic
let devtoolsOpen = false;
function detectDevTools() {
  const threshold = 160;
  const widthDiff = Math.abs(window.outerWidth - window.innerWidth);
  const heightDiff = Math.abs(window.outerHeight - window.innerHeight);
  if (widthDiff > threshold || heightDiff > threshold) devtoolsOpen = true;
  return devtoolsOpen;
}

// UI references
const startBtn = document.getElementById('startBtn');
const startMsg = document.getElementById('startMsg');
const preExam = document.getElementById('preExam');
const examForm = document.getElementById('examForm');
const questionsDiv = document.getElementById('questions');
const violCount = document.getElementById('violCount');
const violList = document.getElementById('violList');
const violBlock = document.getElementById('violations');
const submitBtn = document.getElementById('submitBtn');
const endScreen = document.getElementById('endScreen');
const endTitle = document.getElementById('endTitle');
const endText = document.getElementById('endText');
const restartBtn = document.getElementById('restartBtn');
const enableCam = document.getElementById('enableCam');
const snapshotsDiv = document.getElementById('snapshots');
const elapsed = document.getElementById('elapsed');

// populate questions
function renderQuestions(){
  questionsDiv.innerHTML = '';
  QUESTIONS.forEach((item, idx) => {
    const qWrap = document.createElement('div');
    qWrap.className = 'q';
    qWrap.innerHTML = `<div><strong>Q${idx+1}.</strong> ${item.q}</div>`;
    if(item.type === 'mc'){
      item.choices.forEach((c,i)=>{
        const id = `q${idx}_opt${i}`;
        const radio = document.createElement('label');
        radio.innerHTML = `<input type="radio" name="${item.name}" value="${c}" /> ${c}`;
        qWrap.appendChild(radio);
      });
    } else {
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.name = item.name;
      inp.placeholder = item.placeholder || '';
      qWrap.appendChild(inp);
    }
    questionsDiv.appendChild(qWrap);
  });
}

// violation handling
function addViolation(reason){
  violations++;
  const time = new Date().toLocaleTimeString();
  const entry = `${time} — ${reason}`;
  violationsLog.push(entry);
  violCount.textContent = violations;
  const li = document.createElement('li');
  li.textContent = entry;
  violList.prepend(li);
  violBlock.classList.remove('hidden');

  if(violations >= MAX_VIOL){
    endExam(true);
  }
}

// start exam: request fullscreen, start timers, optionally enable webcam
async function startExam(){
  if (examRunning) return;
  useCam = enableCam.checked;
  // request fullscreen on the card container
  const el = document.getElementById('card');
  try {
    if (el.requestFullscreen) await el.requestFullscreen();
    else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
  } catch(err){
    startMsg.textContent = 'Could not enter fullscreen: ' + err.message;
    return;
  }

  // Ensure fullscreen state (some browsers require user gesture)
  if(!document.fullscreenElement && !document.webkitFullscreenElement){
    startMsg.textContent = 'Please allow fullscreen and try again.';
    return;
  }

  // show form
  preExam.classList.add('hidden');
  examForm.classList.remove('hidden');
  renderQuestions();
  examRunning = true;
  startTime = Date.now();
  timerInterval = setInterval(updateElapsed, 1000);

  // attach behavior listeners
  attachProctorListeners();

  // start cam if allowed
  if(useCam){
    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({ video: { width:320, height:240 }, audio:false });
      const vid = document.createElement('video');
      vid.autoplay = true; vid.muted=true; vid.playsInline = true;
      vid.srcObject = mediaStream;
      vid.style.display = 'none';
      document.body.appendChild(vid);
      // take first snapshot then periodic
      snapshotOnce(vid);
      snapshotInterval = setInterval(()=> snapshotOnce(vid), SNAP_INTERVAL_MS);
    } catch(err){
      addViolation('Camera permission denied or unavailable ('+err.message+')');
    }
  }

  startMsg.textContent = '';
}

// snapshot helper
function snapshotOnce(videoEl){
  try {
    const canvas = document.createElement('canvas');
    canvas.width = 160; canvas.height = 120;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
    const img = document.createElement('img');
    img.src = dataUrl;
    snapshotsDiv.prepend(img);
    // keep only last 20
    while(snapshotsDiv.children.length > 20) snapshotsDiv.removeChild(snapshotsDiv.lastChild);
  } catch(e){
    console.warn('snapshot failed', e);
  }
}

// attach listeners for proctoring heuristics
function attachProctorListeners(){
  // fullscreen changes
  document.addEventListener('fullscreenchange', () => {
    const fs = !!document.fullscreenElement;
    if(!fs && examRunning){
      addViolation('Exited fullscreen');
    }
  });

  // visibility (tab switch / minimize)
  document.addEventListener('visibilitychange', () => {
    if(document.visibilityState !== 'visible' && examRunning){
      addViolation('Switched tab / window hidden (visibilitychange)');
    }
  });

  // blur/focus
  window.addEventListener('blur', () => {
    if(examRunning){
      addViolation('Window lost focus (blur)');
    }
  });

  // copy detection on whole document
  document.addEventListener('copy', (e) => {
    if(examRunning){
      addViolation('Copy action detected');
    }
  });

  // paste detection
  document.addEventListener('paste', (e) => {
    if(examRunning){
      addViolation('Paste action detected');
    }
  });

  // key combinations: detect common new-tab / devtools shortcuts
  document.addEventListener('keydown', (e) => {
    if(!examRunning) return;
    const ctrl = e.ctrlKey || e.metaKey;
    // common suspicious combos
    if(ctrl && (e.key === 't' || e.key === 'n' || e.key === 'Tab')) {
      addViolation('Pressed new tab / window shortcut');
    }
    // F12 or Ctrl+Shift+I
    if(e.key === 'F12' || (ctrl && e.shiftKey && e.key.toLowerCase()==='i')) {
      addViolation('Developer tools shortcut used');
    }
  });

  // periodic devtools check
  setInterval(()=>{
    if(examRunning && detectDevTools()){
      addViolation('Developer tools likely open (heuristic)');
    }
  }, 3000);
}

// update elapsed time
function updateElapsed(){
  if(!startTime) return;
  const diff = Math.floor((Date.now()-startTime)/1000);
  const mm = String(Math.floor(diff/60)).padStart(2,'0');
  const ss = String(diff%60).padStart(2,'0');
  elapsed.textContent = `${mm}:${ss}`;
}

// submit
submitBtn.addEventListener('click', ()=>{
  if(!examRunning) return;
  // collect answers
  const formData = {};
  QUESTIONS.forEach(item => {
    const el = examForm.querySelector(`[name="${item.name}"]`);
    if(!el) return;
    if(item.type === 'mc'){
      const checked = examForm.querySelector(`[name="${item.name}"]:checked`);
      formData[item.name] = checked ? checked.value : null;
    } else {
      formData[item.name] = el.value || '';
    }
  });
  // simple finish
  endExam(false, formData);
});

// end exam
function endExam(terminatedByViolations=false, submissionData=null){
  examRunning = false;
  // stop timers and media
  clearInterval(timerInterval);
  if(snapshotInterval) clearInterval(snapshotInterval);
  if(mediaStream){
    mediaStream.getTracks().forEach(t => t.stop());
  }
  // show end screen
  examForm.classList.add('hidden');
  endScreen.classList.remove('hidden');
  if(terminatedByViolations){
    endTitle.textContent = 'Exam terminated — policy violations';
    endText.innerHTML = `<div class="small">The exam was stopped after ${violations} violations. Violations recorded:<ul>${violationsLog.map(v=>'<li>'+v+'</li>').join('')}</ul></div>`;
  } else {
    endTitle.textContent = 'Exam submitted';
    endText.innerHTML = `<div class="small">Thank you. Your answers (local only): <pre style="white-space:pre-wrap">${JSON.stringify(submissionData, null, 2)}</pre></div>`;
  }
  // exit fullscreen if possible
  try { if(document.exitFullscreen) document.exitFullscreen(); } catch(e){/*ignore*/}
}

// start button hookup
startBtn.addEventListener('click', startExam);

// restart button (just reload)
restartBtn.addEventListener('click', ()=> location.reload());

// small UX: warn user before close while exam running
window.addEventListener('beforeunload', (e) => {
  if(examRunning){
    e.preventDefault();
    e.returnValue = 'Exam is in progress. Are you sure you want to leave?';
    return 'Exam is in progress. Are you sure you want to leave?';
  }
});

// initial render
renderQuestions();

// Extra: if user tries to context menu or right-click copy on questions, detect
document.addEventListener('contextmenu', (e) => {
  // only if right-click inside questions area
  if(examRunning && e.target.closest('.q')) {
    addViolation('Context menu (right-click) used during exam');
  }
});

// Provide a gentle reminder if camera disabled
enableCam.addEventListener('change', ()=>{
  if(!enableCam.checked){
    // user disabled camera: give a heads-up
    startMsg.textContent = 'Camera disabled: snapshots will not be taken. Violations may be more likely to be recorded on tab switches.';
  } else startMsg.textContent = '';
});
</script>
</body>
</html>
